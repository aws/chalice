
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>AWS CloudFormation Support &#8212; AWS Chalice</title><link rel="stylesheet" href="../_static/bootstrap-reboot.css" type="text/css" />
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/default.css" />
    <link rel="stylesheet" href="../_static/custom-tabs.css" type="text/css" />
    

    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script type="text/javascript">
        function _scroll(subjectId) {
            var subjectElement = $(subjectId);
            var actualSubjectHeight = subjectElement.height();
            var startingPosition = subjectElement[0].getBoundingClientRect().top;
            return function() {
                var availableHeight = $(window).height() - startingPosition;
                // Subtract the scroll position to account for sticky movement.
                availableHeight += Math.min($(window).scrollTop(), 40);
                var cappedHeight = Math.min(actualSubjectHeight, availableHeight);
                if (subjectElement.css("height") !== cappedHeight) {
                    subjectElement.css("height", cappedHeight);
                }
            };
        }

        // Scroll and resize the the columns when scrolled.
        $(function() {
            var rightScroll = _scroll("#right-column > .column-body");
            var scrollFn = function() {
                rightScroll.call(this, arguments);
            };
            scrollFn();
            $(window).scroll(scrollFn);
            $(window).resize(scrollFn);
        });

        // Scroll spy to change highlighted navigation element.
        $(function() {
            var section = document.querySelectorAll(".section");
            var sections = {};
            var i = 0;
            Array.prototype.forEach.call(section, function(e) {
                sections[e.id] = e.offsetTop;
            });
            var scrollSpy = function() {
                var scrollPosition = document.documentElement.scrollTop || document.body.scrollTop;
                for (i in sections) {
                    if (sections[i] <= scrollPosition) {
                        $('#right-column .current').removeClass('current');
                        $("#right-column a[href='#" + i + "']").addClass('current');
                    }
                }
            };
            $(window).scroll(scrollSpy);
            scrollSpy();
        });
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-168492171-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-168492171-3');
    </script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Terraform Support" href="tf.html" />
    <link rel="prev" title="Python Version Support" href="pyversion.html" />
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../_static/fonts/open-sans/stylesheet.css" />
  
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  </head><body>
    <header>
        <div class="header-flex width-wrapper">
            <div class="site-logo">
                <a href="../index.html">
		  <span class="logo-icon"><img src="../_static/img/chalice-logo-icon-small.png" /></span>
                </a>
            </div>

            <ul id="page-navigation">
                <li class="site-page first"><a href="../quickstart.html">Quick Start</a></li>
                <li class="site-page"><a href="../tutorials/index.html">Tutorials</a></li>
                <li class="site-page"><a href="../samples/index.html">Samples</a></li>
                <li class="site-page"><a href="../main.html">Documentation</a></li>
                <li class="site-page"><a href="https://github.com/aws/chalice">Code</a></li>
                <li class="site-search hidden-sm">
                    <form action="../search.html" method="get">
                        <input type="hidden" name="check_keywords" value="yes" />
                        <input type="hidden" name="area" value="default" />
                        <input class="search-input" autocomplete="off" type="search" name="q" placeholder="Search" />
                    </form>
                </li>
            </ul>
        </div>
    </header>
    
        
        
        <section id="page-container">
            <div class="width-wrapper flex">
                <article id="document-body">
                    
                    <ul class="rel-parents">
                    <li><a href="index.html" accesskey="U">Topics</a></li>
                    </ul>
                    
                    
  <section id="aws-cloudformation-support">
<h1>AWS CloudFormation Support<a class="headerlink" href="#aws-cloudformation-support" title="Permalink to this headline">¶</a></h1>
<p>When you run <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code>, chalice will deploy your application using the
<a class="reference external" href="http://boto3.readthedocs.io/en/docs/">AWS SDK for Python</a>).  Chalice also
provides functionality that allows you to manage deployments yourself using
cloudformation.  This is provided via the <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">package</span></code> command.</p>
<p>When you run this command, chalice will generate the AWS Lambda deployment
package that contains your application as well as a <a class="reference external" href="https://github.com/awslabs/serverless-application-model">Serverless Application
Model (SAM)</a>
template.  You can then use a tool like the AWS CLI, or any cloudformation
deployment tools you use, to deploy your chalice application.</p>
<section id="considerations">
<h2>Considerations<a class="headerlink" href="#considerations" title="Permalink to this headline">¶</a></h2>
<p>Using the <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">package</span></code> command is useful when you don’t want to
use <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code> to manage your deployments.  There’s several reasons
why you might want to do this:</p>
<ul class="simple">
<li><p>You have pre-existing infrastructure and tooling set up to manage
cloudformation stacks.</p></li>
<li><p>You want to integrate with other cloudformation stacks to manage
all your AWS resources, including resources outside of your chalice
app.</p></li>
<li><p>You’d like to integrate with <a class="reference external" href="https://aws.amazon.com/codepipeline/">AWS CodePipeline</a> to automatically deploy
changes when you push to a git repo.</p></li>
</ul>
<p>Keep in mind that you can’t switch between <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code> and
<code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">package</span></code> + CloudFormation for deploying your app.</p>
<p>If you choose to use <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">package</span></code> and CloudFormation to deploy
your app, you won’t be able to switch back to <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code>.
Running <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code> would create an entirely new set of AWS
resources (API Gateway Rest API, AWS Lambda function, etc).</p>
</section>
<section id="template-merge">
<h2>Template Merge<a class="headerlink" href="#template-merge" title="Permalink to this headline">¶</a></h2>
<p>It’s a common use case to need to modify a Chalice generated template
before deployment. Often to inject extra resources, values, or
configurations that are not supported directly by Chalice. It will
always be the case that something on AWS is not supported by Chalice
directly that a consumer may want to interact with.</p>
<p>The package command can now be invoked with the <code class="docutils literal notranslate"><span class="pre">--merge-template</span></code> argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice package --merge-template extras.json out
</pre></div>
</div>
<p>This extras.json file should be a JSON formatted file which will be
deep-merged on top of the sam.json that is generated by Chalice.</p>
<p>For a simple example lets assume that we have the default new Chalice
project and that extras.json has the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;Resources&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;MusicTable&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Type&quot;</span> <span class="p">:</span> <span class="s2">&quot;AWS::DynamoDB::Table&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;TableName&quot;</span> <span class="p">:</span> <span class="s2">&quot;MusicData&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AttributeDefinitions&quot;</span> <span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;AttributeName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Album&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AttributeType&quot;</span> <span class="p">:</span> <span class="s2">&quot;S&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;AttributeName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Artist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AttributeType&quot;</span> <span class="p">:</span> <span class="s2">&quot;S&quot;</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="s2">&quot;KeySchema&quot;</span> <span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;AttributeName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Album&quot;</span><span class="p">,</span>
            <span class="s2">&quot;KeyType&quot;</span> <span class="p">:</span> <span class="s2">&quot;HASH&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;AttributeName&quot;</span> <span class="p">:</span> <span class="s2">&quot;Artist&quot;</span><span class="p">,</span>
            <span class="s2">&quot;KeyType&quot;</span> <span class="p">:</span> <span class="s2">&quot;RANGE&quot;</span>
          <span class="p">}</span>
        <span class="p">],</span>
        <span class="s2">&quot;ProvisionedThroughput&quot;</span> <span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;ReadCapacityUnits&quot;</span> <span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
          <span class="s2">&quot;WriteCapacityUnits&quot;</span> <span class="p">:</span> <span class="s2">&quot;5&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;APIHandler&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Environment&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Variables&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;MUSIC_TABLE&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Ref&quot;</span><span class="p">:</span> <span class="s2">&quot;MusicTable&quot;</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The generated template located at out/sam.json will have the DynamoDB table
injected into the resource section, as well as the <code class="docutils literal notranslate"><span class="pre">MUSIC_TABLE</span></code> environment
variable added to the <code class="docutils literal notranslate"><span class="pre">APIHandler</span></code> Lambda function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
    <span class="s2">&quot;APIHandler&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;AWS::Serverless::Function&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;Runtime&quot;</span><span class="p">:</span> <span class="s2">&quot;python3.6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Handler&quot;</span><span class="p">:</span> <span class="s2">&quot;app.app&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CodeUri&quot;</span><span class="p">:</span> <span class="s2">&quot;./deployment.zip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;aws-chalice&quot;</span><span class="p">:</span> <span class="s2">&quot;version=1.10-:stage=dev:app=test&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;Timeout&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;MemorySize&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="s2">&quot;Role&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Fn::GetAtt&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;DefaultRole&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Arn&quot;</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="s2">&quot;Environment&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;Variables&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;MUSIC_TABLE&quot;</span><span class="p">:</span> <span class="s2">&quot;MusicData&quot;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This gives us the ability to inject arbitrary resources into our Chalice
applications, and reference them from our Chalice-deployed functions. We can
now rely on Chalice’s policy auto-generation to generate a policy that allows
DynamoDB access, inject our own policy modifications through the same
extras.json file, or specify a custom policy using the config file.</p>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>In this example, we’ll create a chalice app and deploy it using
the AWS CLI.</p>
<p>First install the necessary packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ virtualenv /tmp/venv
$ . /tmp/venv/bin/activate
$ pip install chalice awscli
$ chalice new-project test-cfn-deploy
$ cd test-cfn-deploy
</pre></div>
</div>
<p>At this point we’ve installed chalice and the AWS CLI and we have
a basic app created locally.  Next we’ll run the <code class="docutils literal notranslate"><span class="pre">package</span></code> command
and look at its contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ $ chalice package /tmp/packaged-app/
Creating deployment package.
$ ls -la /tmp/packaged-app/
-rw-r--r--   1 j         wheel  3355270 May 25 14:20 deployment.zip
-rw-r--r--   1 j         wheel     3068 May 25 14:20 sam.json

$ unzip -l /tmp/packaged-app/deployment.zip  | tail -n 5
    17292  05-25-17 14:19   chalice/app.py
      283  05-25-17 14:19   chalice/__init__.py
      796  05-25-17 14:20   app.py
 --------                   -------
  9826899                   723 files

$ head &lt; /tmp/packaged-app/sam.json
{
  &quot;AWSTemplateFormatVersion&quot;: &quot;2010-09-09&quot;,
  &quot;Outputs&quot;: {
    &quot;RestAPIId&quot;: {
      &quot;Value&quot;: {
        &quot;Ref&quot;: &quot;RestAPI&quot;
      }
    },
    &quot;APIHandlerName&quot;: {
      &quot;Value&quot;: {
</pre></div>
</div>
<p>As you can see in the above example, the <code class="docutils literal notranslate"><span class="pre">package</span></code> command created a
directory that contained two files, a <code class="docutils literal notranslate"><span class="pre">deployment.zip</span></code> file, which is the
Lambda deployment package, and a <code class="docutils literal notranslate"><span class="pre">sam.json</span></code> file, which is the SAM template
that can be deployed using CloudFormation.  Next we’re going to use the AWS CLI
to deploy our app.  To this, we’ll first run the <code class="docutils literal notranslate"><span class="pre">aws</span> <span class="pre">cloudformation</span> <span class="pre">package</span></code>
command, which will take our deployment.zip file and upload to an S3 bucket
we specify:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws cloudformation package \
     --template-file /tmp/packaged-app/sam.json \
     --s3-bucket myapp-bucket \
     --output-template-file /tmp/packaged-app/packaged.yaml
</pre></div>
</div>
<p>Now we can deploy our app using the <code class="docutils literal notranslate"><span class="pre">aws</span> <span class="pre">cloudformation</span> <span class="pre">deploy</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws cloudformation deploy \
    --template-file /tmp/packaged-app/packaged.yaml \
    --stack-name test-cfn-stack \
    --capabilities CAPABILITY_IAM
Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - test-cfn-stack
</pre></div>
</div>
<p>This will take a few minutes to complete, but once it’s done, the endpoint url
will be available as an output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws cloudformation describe-stacks --stack-name test-cfn-stack \
  --query &quot;Stacks[].Outputs[?OutputKey==&#39;EndpointURL&#39;][] | [0].OutputValue&quot;
&quot;https://abc29hkq0i.execute-api.us-west-2.amazonaws.com/api/&quot;

$ http &quot;https://abc29hkq0i.execute-api.us-west-2.amazonaws.com/api/&quot;
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 18
Content-Type: application/json
...

{
    &quot;hello&quot;: &quot;world&quot;
}
</pre></div>
</div>
</section>
</section>


                    
                    <section class="relations">
                        
                        <a href="pyversion.html" title="previous chapter" class="previous-page clearfix hidden-xs">← Python Version Support</a>
                        
                        <a href="tf.html" title="next chapter" class="next-page clearfix">Terraform Support →</a>
                    </section>
                    
                </article><aside id="right-column" class="side-column hidden-sm">
                    <div class="column-body">
                        <section class="sidebar">
                            
                            <section class="next-previous">
                                
                                <a href="pyversion.html" title="previous chapter" class="previous-page clearfix hidden-xs">← Prev</a>
                                
                                <a href="tf.html" title="next chapter" class="next-page clearfix">Next →</a>
                            </section>
                            
                            <ul>
<li><a class="reference internal" href="#">AWS CloudFormation Support</a><ul>
<li><a class="reference internal" href="#considerations">Considerations</a></li>
<li><a class="reference internal" href="#template-merge">Template Merge</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
</ul>

                        </section>
                    </div>
                </aside></div>
        </section>
        
    
<footer id="footer">
    <div class="width-wrapper">
        <div class="copyright">
            <p>©2020, Amazon Web Services, Inc or its affiliates. All rights reserved.</p>
        </div>
    </div>
</footer>
  </body>
</html>