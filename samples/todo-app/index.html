
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Todo Application &#8212; AWS Chalice</title><link rel="stylesheet" href="../../_static/bootstrap-reboot.css" type="text/css" />
    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css" />
    <link rel="stylesheet" href="../../_static/custom-tabs.css" type="text/css" />
    

    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script type="text/javascript">
        function _scroll(subjectId) {
            var subjectElement = $(subjectId);
            var actualSubjectHeight = subjectElement.height();
            var startingPosition = subjectElement[0].getBoundingClientRect().top;
            return function() {
                var availableHeight = $(window).height() - startingPosition;
                // Subtract the scroll position to account for sticky movement.
                availableHeight += Math.min($(window).scrollTop(), 40);
                var cappedHeight = Math.min(actualSubjectHeight, availableHeight);
                if (subjectElement.css("height") !== cappedHeight) {
                    subjectElement.css("height", cappedHeight);
                }
            };
        }

        // Scroll and resize the the columns when scrolled.
        $(function() {
            var rightScroll = _scroll("#right-column > .column-body");
            var scrollFn = function() {
                rightScroll.call(this, arguments);
            };
            scrollFn();
            $(window).scroll(scrollFn);
            $(window).resize(scrollFn);
        });

        // Scroll spy to change highlighted navigation element.
        $(function() {
            var section = document.querySelectorAll(".section");
            var sections = {};
            var i = 0;
            Array.prototype.forEach.call(section, function(e) {
                sections[e.id] = e.offsetTop;
            });
            var scrollSpy = function() {
                var scrollPosition = document.documentElement.scrollTop || document.body.scrollTop;
                for (i in sections) {
                    if (sections[i] <= scrollPosition) {
                        $('#right-column .current').removeClass('current');
                        $("#right-column a[href='#" + i + "']").addClass('current');
                    }
                }
            };
            $(window).scroll(scrollSpy);
            scrollSpy();
        });
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-168492171-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-168492171-3');
    </script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Upgrade Notes" href="../../upgrading.html" />
    <link rel="prev" title="Media Query Application" href="../media-query/index.html" />
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  </head><body>
    <header>
        <div class="header-flex width-wrapper">
            <div class="site-logo">
                <a href="../../index.html">
		  <span class="logo-icon"><img src="../../_static/img/chalice-logo-icon-small.png" /></span>
                </a>
            </div>

            <ul id="page-navigation">
                <li class="site-page first"><a href="../../quickstart.html">Quick Start</a></li>
                <li class="site-page"><a href="../../tutorials/index.html">Tutorials</a></li>
                <li class="site-page"><a href="../index.html">Samples</a></li>
                <li class="site-page"><a href="../../main.html">Documentation</a></li>
                <li class="site-page"><a href="https://github.com/aws/chalice">Code</a></li>
                <li class="site-search hidden-sm">
                    <form action="../../search.html" method="get">
                        <input type="hidden" name="check_keywords" value="yes" />
                        <input type="hidden" name="area" value="default" />
                        <input class="search-input" autocomplete="off" type="search" name="q" placeholder="Search" />
                    </form>
                </li>
            </ul>
        </div>
    </header>
    
        
        
        <section id="page-container">
            <div class="width-wrapper flex">
                <article id="document-body">
                    
                    <ul class="rel-parents">
                    <li><a href="../index.html" accesskey="U">Sample Applications</a></li>
                    </ul>
                    
                    
  <section id="todo-application">
<h1>Todo Application<a class="headerlink" href="#todo-application" title="Permalink to this headline">¶</a></h1>
<p>This is a sample application that allows you to manage Todo items.  This
tutorial will walk through creating a serverless web API to create, update,
get, and delete Todos, managing Todos in a database, and adding authorization
with JWT.  AWS services covered include AWS Lambda, Amazon API Gateway, Amazon
DynamoDB, AWS CodeBuild, and AWS Systems Manager.</p>
<p>You can find the full source code for this application in our
<a class="reference external" href="https://github.com/aws/chalice/tree/master/docs/source/samples/todo-app/code/">samples directory on GitHub</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone git://github.com/aws/chalice
$ cd chalice/docs/source/samples/todo-app/code
</pre></div>
</div>
<p>We’ll now walk through the architecture of this application,
how to deploy and use the application, and finally we’ll go over
the main components of the application code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This sample application is also available as a <a class="reference external" href="https://chalice-workshop.readthedocs.io/en/latest/todo-app/index.html">workshop</a>.
The main difference between the sample apps here and the Chalice workshops
is that the workshop is a detailed step by step process for how to create
this application from scratch.  You build the app by gradually adding each
feature piece by piece.  In the workshop, we first create a REST API with
no authentication or data store.  Then we introduce DynamoDB, then JWT
auth, etc.  The workshop also shows you how to set up a CI/CD pipeline
to automatically deploy your application whenever you push to your git
repository.  It takes several hours to work through all the workshop
material.  In this document we review the architecture, the deployment process,
then walk through the main sections of the final version of this
application.</p>
</div>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>The main component of this application is a REST API backed by Amazon API
Gateway and AWS Lambda.  The rest API lets you manage a Todo list.  It lets you
create a new Todo list as well as check off existing Todo items.</p>
<p>In order to see a list of your Todo items, you must first log in.  Information
about our users is stored in an Amazon DynamoDB table.  The authentication is
done using a builtin authorizer.  This lets you define a Lambda function to
perform your custom auth process.  For this sample app, we’re using JSON Web
Tokens (JWT).</p>
<p>The Todo items are stored in a separate DynamoDB table.  Below is
an architecture diagram of our sample app.  It shows the API Gateway
REST API, along with a Lambda function for our authorizer, a Lambda function
for our REST API, and two DynamoDB tables.</p>
<a class="reference internal image-reference" href="../../_images/architecture.jpg"><img alt="Architecture diagram" src="../../_images/architecture.jpg" style="width: 100%;" /></a>
<section id="rest-api">
<span id="todo-sample-rest-api"></span><h3>REST API<a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h3>
<p>The REST API supports the following resources:</p>
<ul class="simple">
<li><p>GET    - <code class="docutils literal notranslate"><span class="pre">/todos/</span></code> - Gets a list of all todo items</p></li>
<li><p>POST   - <code class="docutils literal notranslate"><span class="pre">/todos/</span></code> - Creates a new Todo item</p></li>
<li><p>GET    - <code class="docutils literal notranslate"><span class="pre">/todos/{id}</span></code> - Gets a specific todo item</p></li>
<li><p>DELETE - <code class="docutils literal notranslate"><span class="pre">/todos/{id}</span></code> - Deletes a specific todo item</p></li>
<li><p>PUT    - <code class="docutils literal notranslate"><span class="pre">/todos/{id}</span></code> - Updates the state of a todo item</p></li>
</ul>
<p>A todo item has this schema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">},</span>
  <span class="s2">&quot;uid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type: &quot;</span><span class="nb">str</span><span class="s2">&quot;},</span>
  <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type: &quot;</span><span class="nb">str</span><span class="s2">&quot;, &quot;</span><span class="n">enum</span><span class="s2">&quot;: [&quot;</span><span class="n">unstarted</span><span class="s2">&quot;, &quot;</span><span class="n">started</span><span class="s2">&quot;, &quot;</span><span class="n">completed</span><span class="s2">&quot;]},</span>
  <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>To run and deploy this application, first create a virtual environment
and install the dependencies.  Python 3.7 is used for this sample app.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python3 -m /tmp/venv37
$ . /tmp/venv37/bin/activate
$ pip install ./requirements-dev.txt
$ pip install ./requirements.txt
</pre></div>
</div>
<p>As part of this application, there are additional resources that
are created that are used by this application, including two DynamoDB
tables as well as an SSM parameter used to store our secret key used
in our JWT auth.  To create these resources, you can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python create-resources.py
</pre></div>
</div>
<p>This will also update your <code class="docutils literal notranslate"><span class="pre">.chalice/config.json</span></code> file with environment
variables containing the name of the DynamoDB tables that were created.</p>
<p>At this point, you can either test the application by running <code class="docutils literal notranslate"><span class="pre">chalice</span>
<span class="pre">local</span></code>.  This will start a local HTTP server on port 8000 that emulates API
Gateway so that you can test without having to deploy your application to AWS.
You can also run <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code> to deploy your application to
AWS, which allows you to test on an actual API Gateway REST API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice deploy
Creating deployment package.
Creating IAM role: mytodo-dev-api_handler
Creating lambda function: mytodo-dev
Creating IAM role: mytodo-dev-jwt_auth
Creating lambda function: mytodo-dev-jwt_auth
Creating Rest API
Resources deployed:
  - Lambda ARN: arn:aws:lambda:us-east-1:12345:function:mytodo-dev
  - Lambda ARN: arn:aws:lambda:us-east-1:12345:function:mytodo-dev-jwt_auth
  - Rest API URL: https://abcd.execute-api.us-west-2.amazonaws.com/api/
</pre></div>
</div>
</section>
<section id="using-the-application">
<h2>Using the Application<a class="headerlink" href="#using-the-application" title="Permalink to this headline">¶</a></h2>
<p>If you’ve deployed your application using <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code>, you can test
the REST API by making requests to the <code class="docutils literal notranslate"><span class="pre">Rest</span> <span class="pre">API</span> <span class="pre">URL</span></code>, shown in the output
of <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code>, in our example that would be
<code class="docutils literal notranslate"><span class="pre">https://abcd.execute-api.us-west-2.amazonaws.com/api/</span></code>.  If you’re using
<code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">local</span></code>, you’ll make requests to <code class="docutils literal notranslate"><span class="pre">http://localhost:8000/</span></code>.</p>
<p>Before we can make requests we need to authenticate with the API.  In order
to authenticate with the API we need to create user accounts.</p>
<p>A helper script, <code class="docutils literal notranslate"><span class="pre">users.py</span></code> is included in the repository to help you
manage users.  The first thing we’ll need to do is create a user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python users.py --create-user
Username: myusername
Password:
</pre></div>
</div>
<p>This will create a new entry in our users DynamoDB table.
You can then test that the password verification works by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python users.py --test-password
Username: myusername
Password:
Password verified.
</pre></div>
</div>
<p>Once we’ve created a test user, we can now login by sending a POST
request to the <code class="docutils literal notranslate"><span class="pre">/login</span></code> URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ echo &#39;{&quot;username&quot;: &quot;myusername&quot;, &quot;password&quot;: &quot;mypassword&quot;}&#39; | \
    http POST https://abcd.execute-api.us-west-2.amazonaws.com/api/login/
{
    &quot;token&quot;: &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJteXVzZXJuYW1lIiwiaWF0IjoxNTk1NDU3Njg5LCJuYmYiOjE1OTU0NTc2ODksImp0aSI6IjMxNjc4YzFkLTdkZjEtNGEzOC04YmZiLTllZjZiMGM1YzAyNyJ9.w46RdtzZdk_P0LAh_St3wjsqgh-k-Hp1ykTpbDqad2k&quot;,
}
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We’re using the HTTPie command line tool instead of cURL.  You can
install this tool by running <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">httpie</span></code>.</p>
</div>
<p>Now whenever we make any requests to our REST API, we need to include
the token value in the output above as the value of our <code class="docutils literal notranslate"><span class="pre">Authorization</span></code>
header.  For example, we can list all of our Todos, which is initially
empty:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http https://abcd.execute-api.us-west-2.amazonaws.com/api/todos/ &#39;Authorization: my.jwt.token&#39;
HTTP/1.1 200 OK
Content-Length: 2
Content-Type: application/json

[]
</pre></div>
</div>
<p>If you omit the <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> header, you’ll see this error response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http https://abcd.execute-api.us-west-2.amazonaws.com/api/todos/
HTTP/1.1 401 Unauthorized
Content-Length: 26
Content-Type: application/json
x-amzn-ErrorType: UnauthorizedException

{
    &quot;message&quot;: &quot;Unauthorized&quot;
}
</pre></div>
</div>
<p>We can create a new Todo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ echo &#39;{&quot;description&quot;: &quot;My first Todo&quot;, &quot;metadata&quot;: {}}&#39; \
    |  http POST https://abcd.execute-api.us-west-2.amazonaws.com/api/todos/ \
       &#39;Authorization: my.jwt.token&#39;
HTTP/1.1 200 OK
Content-Length: 36
Content-Type: application/json

e25643f7-0b18-47d2-b124-4e6713ab527c
</pre></div>
</div>
<p>Now when we list our Todos, we’ll see our new entry we created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http https://abcd.execute-api.us-west-2.amazonaws.com/api/todos/ &#39;Authorization: my.jwt.token&#39;
HTTP/1.1 200 OK
Content-Length: 136
Content-Type: application/json

[
    {
        &quot;description&quot;: &quot;My first Todo&quot;,
        &quot;metadata&quot;: {},
        &quot;state&quot;: &quot;unstarted&quot;,
        &quot;uid&quot;: &quot;e25643f7-0b18-47d2-b124-4e6713ab527c&quot;,
        &quot;username&quot;: &quot;myusername&quot;
    }
]
</pre></div>
</div>
<p>We can update our Todo and mark it completed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ echo &#39;{&quot;state&quot;: &quot;completed&quot;}&#39; |  \
    http PUT https://abcd.execute-api.us-west-2.amazonaws.com/api/todos/e25643f7-0b18-47d2-b124-4e6713ab527c \
    &#39;Authorization: my.jwt.token&#39;
HTTP/1.1 200 OK
Content-Length: 4
Content-Type: application/json

null
</pre></div>
</div>
<p>And we can now verify that the Todo item shows up as completed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http https://abcd.execute-api.us-west-2.amazonaws.com/api/todos/e25643f7-0b18-47d2-b124-4e6713ab527c \
    &#39;Authorization: my.jwt.token&#39;
HTTP/1.1 200 OK
Content-Length: 134
Content-Type: application/json

{
    &quot;description&quot;: &quot;My first Todo&quot;,
    &quot;metadata&quot;: {},
    &quot;state&quot;: &quot;completed&quot;,
    &quot;uid&quot;: &quot;e25643f7-0b18-47d2-b124-4e6713ab527c&quot;,
    &quot;username&quot;: &quot;myusername&quot;
}
</pre></div>
</div>
</section>
<section id="code-walkthrough">
<h2>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Permalink to this headline">¶</a></h2>
<section id="todo-app-rest-api">
<span id="id1"></span><h3>Rest API<a class="headerlink" href="#todo-app-rest-api" title="Permalink to this headline">¶</a></h3>
<p>Below is the code for the five routes defined in the
<a class="reference internal" href="#todo-sample-rest-api"><span class="std std-ref">REST API</span></a> section defined in the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">app.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 67</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todos&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">jwt_auth</span><span class="p">)</span>
<span class="linenos"> 68</span><span class="k">def</span> <span class="nf">list_todos</span><span class="p">():</span>
<span class="linenos"> 69</span>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_authorized_username</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="p">)</span>
<span class="linenos"> 70</span>    <span class="k">return</span> <span class="n">get_app_db</span><span class="p">()</span><span class="o">.</span><span class="n">list_items</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todos&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">],</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">jwt_auth</span><span class="p">)</span>
<span class="linenos"> 74</span><span class="k">def</span> <span class="nf">create_todo</span><span class="p">():</span>
<span class="linenos"> 75</span>    <span class="n">body</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">json_body</span>
<span class="linenos"> 76</span>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_authorized_username</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="p">)</span>
<span class="linenos"> 77</span>    <span class="k">return</span> <span class="n">get_app_db</span><span class="p">()</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span>
<span class="linenos"> 78</span>        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
<span class="linenos"> 79</span>        <span class="n">description</span><span class="o">=</span><span class="n">body</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span>
<span class="linenos"> 80</span>        <span class="n">metadata</span><span class="o">=</span><span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">),</span>
<span class="linenos"> 81</span>    <span class="p">)</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todos/</span><span class="si">{uid}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">jwt_auth</span><span class="p">)</span>
<span class="linenos"> 85</span><span class="k">def</span> <span class="nf">get_todo</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
<span class="linenos"> 86</span>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_authorized_username</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="p">)</span>
<span class="linenos"> 87</span>    <span class="k">return</span> <span class="n">get_app_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todos/</span><span class="si">{uid}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">],</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">jwt_auth</span><span class="p">)</span>
<span class="linenos"> 91</span><span class="k">def</span> <span class="nf">update_todo</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
<span class="linenos"> 92</span>    <span class="n">body</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">json_body</span>
<span class="linenos"> 93</span>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_authorized_username</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="p">)</span>
<span class="linenos"> 94</span>    <span class="n">get_app_db</span><span class="p">()</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
<span class="linenos"> 95</span>        <span class="n">uid</span><span class="p">,</span>
<span class="linenos"> 96</span>        <span class="n">description</span><span class="o">=</span><span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">),</span>
<span class="linenos"> 97</span>        <span class="n">state</span><span class="o">=</span><span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">),</span>
<span class="linenos"> 98</span>        <span class="n">metadata</span><span class="o">=</span><span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">),</span>
<span class="linenos"> 99</span>        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
<span class="linenos">100</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todos/</span><span class="si">{uid}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">],</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">jwt_auth</span><span class="p">)</span>
<span class="linenos">103</span><span class="k">def</span> <span class="nf">delete_todo</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
<span class="linenos">104</span>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_authorized_username</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="p">)</span>
<span class="linenos">105</span>    <span class="k">return</span> <span class="n">get_app_db</span><span class="p">()</span><span class="o">.</span><span class="n">delete_item</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The first thing all of these routes do is extract the current username from the
request.  This is done by examining the context associated with the current
request.  This will include the <code class="docutils literal notranslate"><span class="pre">principalId</span></code>, or the current username, which
is discussed in more detail in the <a class="reference internal" href="#todo-app-jwt-auth"><span class="std std-ref">JWT Authentication</span></a> section below.</p>
<p>Each of these routes then makes a call into the data storage layer,
and either retrieves or updates data in the <code class="docutils literal notranslate"><span class="pre">Todo</span></code> DynamoDB table.
This is discussed in the next section on data storage.</p>
<p>The application DB is tracked as a module level variable that is
retrieved through the <code class="docutils literal notranslate"><span class="pre">get_app_db()</span></code> function.  The name of the
DynamoDB table is provided through the <code class="docutils literal notranslate"><span class="pre">APP_TABLE_NAME</span></code> environment
variable, which is specified in your <code class="docutils literal notranslate"><span class="pre">.chalice/config.json</span></code> file.
This was automatically filled in for you when you ran the
<code class="docutils literal notranslate"><span class="pre">create-resources.py</span></code> script.</p>
<p>User input is extracted from both the URL (the <code class="docutils literal notranslate"><span class="pre">uid</span></code> associated with
a Todo item is provided as part of the URL) as well as the JSON
request body.  A key takeaway from these routes is that there’s
minimal logic in the route definitions themselves.  They’re primarily
about extracting user input and then delegating the heavy lifting to
other objects that are independent of any routing information.</p>
</section>
<section id="data-storage">
<h3>Data Storage<a class="headerlink" href="#data-storage" title="Permalink to this headline">¶</a></h3>
<p>Each route in this sample application app makes a call to the
data storage layer, which is backed by a DynamoDB table.  This interface
is defined by the <code class="docutils literal notranslate"><span class="pre">TodoDB</span></code> interface, which is defined in the
<code class="docutils literal notranslate"><span class="pre">chalicelib/db.py</span></code> file:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">chalicelib/db.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 9</span><span class="k">class</span> <span class="nc">TodoDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="linenos">10</span>    <span class="k">def</span> <span class="nf">list_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">11</span>        <span class="k">pass</span>
<span class="linenos">12</span>
<span class="linenos">13</span>    <span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">14</span>        <span class="k">pass</span>
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="k">def</span> <span class="nf">get_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
<span class="linenos">17</span>        <span class="k">pass</span>
<span class="linenos">18</span>
<span class="linenos">19</span>    <span class="k">def</span> <span class="nf">delete_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
<span class="linenos">20</span>        <span class="k">pass</span>
<span class="linenos">21</span>
<span class="linenos">22</span>    <span class="k">def</span> <span class="nf">update_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">23</span>                    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">24</span>        <span class="k">pass</span>
</pre></div>
</div>
</div>
<p>There are two different implementations of this interface.  The first one,
<code class="docutils literal notranslate"><span class="pre">InMemoryTodoDB</span></code>, is an in-memory implementation of this interface where
all data is stored within the process.  The purpose of this implementation
is for testing purposes when you don’t want to work with the real DynamoDB
service.  This allows you to develop your application locally and test
using <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">local</span></code>.  The other implementation of <code class="docutils literal notranslate"><span class="pre">TodoDB</span></code> interface is
<code class="docutils literal notranslate"><span class="pre">DynamoDBTodo</span></code>, which communicates with the actual DynamoDB service
to store and retrieve Todo items.  It uses the Table resource of <code class="docutils literal notranslate"><span class="pre">boto3</span></code>,
created via <code class="docutils literal notranslate"><span class="pre">boto3.resource('dynamodb').Table(TABLE_NAME)</span></code>.  This allows
us to use the <a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/customizations/dynamodb.html#dynamodb-conditions">high level querying interface of boto3</a>.
The implementation is shown below.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">chalicelib/db.py</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 72</span><span class="k">class</span> <span class="nc">DynamoDBTodo</span><span class="p">(</span><span class="n">TodoDB</span><span class="p">):</span>
<span class="linenos"> 73</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_resource</span><span class="p">):</span>
<span class="linenos"> 74</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">table_resource</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>    <span class="k">def</span> <span class="nf">list_all_items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 77</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
<span class="linenos"> 78</span>        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>    <span class="k">def</span> <span class="nf">list_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">DEFAULT_USERNAME</span><span class="p">):</span>
<span class="linenos"> 81</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
<span class="linenos"> 82</span>            <span class="n">KeyConditionExpression</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
<span class="linenos"> 83</span>        <span class="p">)</span>
<span class="linenos"> 84</span>        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">]</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span>    <span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">DEFAULT_USERNAME</span><span class="p">):</span>
<span class="linenos"> 87</span>        <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<span class="linenos"> 88</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
<span class="linenos"> 89</span>            <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
<span class="linenos"> 90</span>                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
<span class="linenos"> 91</span>                <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span>
<span class="linenos"> 92</span>                <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
<span class="linenos"> 93</span>                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;unstarted&#39;</span><span class="p">,</span>
<span class="linenos"> 94</span>                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{},</span>
<span class="linenos"> 95</span>            <span class="p">}</span>
<span class="linenos"> 96</span>        <span class="p">)</span>
<span class="linenos"> 97</span>        <span class="k">return</span> <span class="n">uid</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="k">def</span> <span class="nf">get_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">DEFAULT_USERNAME</span><span class="p">):</span>
<span class="linenos">100</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
<span class="linenos">101</span>            <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">102</span>                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
<span class="linenos">103</span>                <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span>
<span class="linenos">104</span>            <span class="p">},</span>
<span class="linenos">105</span>        <span class="p">)</span>
<span class="linenos">106</span>        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span>
<span class="linenos">107</span>
<span class="linenos">108</span>    <span class="k">def</span> <span class="nf">delete_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">DEFAULT_USERNAME</span><span class="p">):</span>
<span class="linenos">109</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">delete_item</span><span class="p">(</span>
<span class="linenos">110</span>            <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
<span class="linenos">111</span>                <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
<span class="linenos">112</span>                <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span>
<span class="linenos">113</span>            <span class="p">}</span>
<span class="linenos">114</span>        <span class="p">)</span>
<span class="linenos">115</span>
<span class="linenos">116</span>    <span class="k">def</span> <span class="nf">update_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos">117</span>                    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">DEFAULT_USERNAME</span><span class="p">):</span>
<span class="linenos">118</span>        <span class="c1"># We could also use update_item() with an UpdateExpression.</span>
<span class="linenos">119</span>        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
<span class="linenos">120</span>        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">121</span>            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
<span class="linenos">122</span>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">123</span>            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
<span class="linenos">124</span>        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">125</span>            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
<span class="linenos">126</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="jwt-authentication">
<span id="todo-app-jwt-auth"></span><h3>JWT Authentication<a class="headerlink" href="#jwt-authentication" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example is for illustration purposes and does not necessarily
represent best practices.  Its intent is to show how custom
authentication can be implemented in a Chalice app.</p>
</div>
<p>Our REST API for our Todo items requires that you send an appropriate
<code class="docutils literal notranslate"><span class="pre">Authorization</span></code> header when making HTTP requests.  You can retrieve
a auth token by making a request to the <code class="docutils literal notranslate"><span class="pre">/login</span></code> route with your
user name and password.  The underlying mechanism used to handle
our auth functionality is through issuing a
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7519">JWT</a> when you login.</p>
<section id="users-table">
<h4>Users Table<a class="headerlink" href="#users-table" title="Permalink to this headline">¶</a></h4>
<p>In order to login, we need a way to store and retrieve user information.  This
is done through our <code class="docutils literal notranslate"><span class="pre">Users</span></code> DynamoDB table.  This was created when you ran
the <code class="docutils literal notranslate"><span class="pre">create-resoureces.py</span></code> file.  Each user record stores their username and
information about their password.  We’re using PBKDF2 as our key derivation
function for password hashing, which is available in Python’s standard library
through the <a class="reference external" href="https://docs.python.org/3/library/hashlib.html#hashlib.pbkdf2_hmac">hashlib.pbkdf2_hmac</a>
function.  The parameters needed by <code class="docutils literal notranslate"><span class="pre">pbkdf2_hmac</span></code> are stored in each user’s
record, including the password hash, salt, number of rounds, and the hash used
for PBKDF2 (sha256 in our example).  These user entries were created and stored
in the <code class="docutils literal notranslate"><span class="pre">Users</span></code> DynamoDB table when you ran the <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">users.py</span>
<span class="pre">--create-user</span></code> command.
You can see the fields for a specific user by using the <code class="docutils literal notranslate"><span class="pre">--get-user</span></code> option
to the <code class="docutils literal notranslate"><span class="pre">users.py</span></code> script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python users.py --get-user myusername
Entry for user: myusername
  hash      : sha256
  username  : myusername
  hashed    : Hym8Ss6WIArus+aZ6BucZ3sz6Wu5w8Tc3lPUivTuUi4=
  salt      : rXMPBx8ZriKU3SQTh58BlxQQtpcLHfmITTB2tpRs/sM=
  rounds    : 100000
</pre></div>
</div>
</section>
<section id="login-flow">
<h4>Login Flow<a class="headerlink" href="#login-flow" title="Permalink to this headline">¶</a></h4>
<p>Below is the code for the <code class="docutils literal notranslate"><span class="pre">/login</span></code> route:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">app.py</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">17</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos">18</span><span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
<span class="linenos">19</span>    <span class="n">body</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">json_body</span>
<span class="linenos">20</span>    <span class="n">record</span> <span class="o">=</span> <span class="n">get_users_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
<span class="linenos">21</span>        <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]})[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span>
<span class="linenos">22</span>    <span class="n">jwt_token</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_jwt_token</span><span class="p">(</span>
<span class="linenos">23</span>        <span class="n">body</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">body</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="n">record</span><span class="p">,</span> <span class="n">get_auth_key</span><span class="p">())</span>
<span class="linenos">24</span>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">jwt_token</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In this login view, we first lookup the user record fom our users DB,
and then try to generate a JWT token for this entry.  The
<code class="docutils literal notranslate"><span class="pre">auth.get_jwt_token</span></code> will first verify that the password hash
matches what’s stored in our users DB, and then generate a JWT token
for this user as shown in the code below:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">chalicelib/auth.py</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">10</span><span class="k">def</span> <span class="nf">get_jwt_token</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
<span class="linenos">11</span>    <span class="n">actual</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">pbkdf2_hmac</span><span class="p">(</span>
<span class="linenos">12</span>        <span class="n">record</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">],</span>
<span class="linenos">13</span>        <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
<span class="linenos">14</span>        <span class="n">record</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<span class="linenos">15</span>        <span class="nb">int</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;rounds&#39;</span><span class="p">])</span>
<span class="linenos">16</span>    <span class="p">)</span>
<span class="linenos">17</span>    <span class="n">expected</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;hashed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="linenos">18</span>    <span class="k">if</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="linenos">19</span>        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="linenos">20</span>        <span class="n">unique_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<span class="linenos">21</span>        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">22</span>            <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
<span class="linenos">23</span>            <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
<span class="linenos">24</span>            <span class="s1">&#39;nbf&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
<span class="linenos">25</span>            <span class="s1">&#39;jti&#39;</span><span class="p">:</span> <span class="n">unique_id</span><span class="p">,</span>
<span class="linenos">26</span>            <span class="c1"># NOTE: We can also add &#39;exp&#39; if we want tokens to expire.</span>
<span class="linenos">27</span>        <span class="p">}</span>
<span class="linenos">28</span>        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">)</span>
<span class="linenos">29</span>    <span class="k">raise</span> <span class="n">UnauthorizedError</span><span class="p">(</span><span class="s1">&#39;Invalid password&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The call to <code class="docutils literal notranslate"><span class="pre">jwt.encode()</span></code> requires a payload and a secret.
This secret is a value that is only known to our application and is
used in our built-in authorizer to verify the JWT is valid.
This secret value is stored as an SSM parameter.  A random secret
was automatically generated and stored in SSM for you when running the
<code class="docutils literal notranslate"><span class="pre">create-resources.py</span></code> script.  When we call <code class="docutils literal notranslate"><span class="pre">auth.get_jwt_token</span></code> we first
retrieve this value from SSM as shown in the <code class="docutils literal notranslate"><span class="pre">get_auth_key()</span></code> function
defined in our <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">app.py</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">34</span><span class="k">def</span> <span class="nf">get_auth_key</span><span class="p">():</span>
<span class="linenos">35</span>    <span class="k">global</span> <span class="n">_AUTH_KEY</span>
<span class="linenos">36</span>    <span class="k">if</span> <span class="n">_AUTH_KEY</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">37</span>        <span class="n">base64_key</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ssm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span>
<span class="linenos">38</span>            <span class="n">Name</span><span class="o">=</span><span class="n">_SSM_AUTH_KEY_NAME</span><span class="p">,</span>
<span class="linenos">39</span>            <span class="n">WithDecryption</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">40</span>        <span class="p">)[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">][</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
<span class="linenos">41</span>        <span class="n">_AUTH_KEY</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">base64_key</span><span class="p">)</span>
<span class="linenos">42</span>    <span class="k">return</span> <span class="n">_AUTH_KEY</span>
</pre></div>
</div>
</div>
<p>Once we’ve generated a JWT token, we return the token back to the caller.
They must then provide that same token in the <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> header
whenever they make API calls to the REST API.</p>
</section>
<section id="custom-authorizer">
<h4>Custom Authorizer<a class="headerlink" href="#custom-authorizer" title="Permalink to this headline">¶</a></h4>
<p>In order to require that a specific route requires proper authorization,
we must first create an authorizer, and then associate it with any routes
that require auth.  Chalice supports different types of
<a class="reference internal" href="../../topics/authorizers.html"><span class="doc">Authorization</span></a>, and in this example we’re using the
<a class="reference internal" href="../../topics/authorizers.html#builtin-authorizers"><span class="std std-ref">Built-in Authorizers</span></a> type provided by Chalice.  This lets us write
our custom authorization logic as part of our Chalice app.  To do this,
we decorate our auth function with the <code class="docutils literal notranslate"><span class="pre">&#64;app.authorizer</span></code> decorator.
Our custom authorizer logic takes the JWT token (accessible through the
<code class="docutils literal notranslate"><span class="pre">auth_request.token</span></code> attribute, and verifies the token is valid
using our secret key retrieved via <code class="docutils literal notranslate"><span class="pre">get_auth_key()</span></code>.  The custom
authorizer is shown below:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">app.py</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">27</span><span class="nd">@app</span><span class="o">.</span><span class="n">authorizer</span><span class="p">()</span>
<span class="linenos">28</span><span class="k">def</span> <span class="nf">jwt_auth</span><span class="p">(</span><span class="n">auth_request</span><span class="p">):</span>
<span class="linenos">29</span>    <span class="n">token</span> <span class="o">=</span> <span class="n">auth_request</span><span class="o">.</span><span class="n">token</span>
<span class="linenos">30</span>    <span class="n">decoded</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">decode_jwt_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">get_auth_key</span><span class="p">())</span>
<span class="linenos">31</span>    <span class="k">return</span> <span class="n">AuthResponse</span><span class="p">(</span><span class="n">routes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span> <span class="n">principal_id</span><span class="o">=</span><span class="n">decoded</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Once we verify that JWT token is valid, we return an <code class="docutils literal notranslate"><span class="pre">AuthResponse</span></code> that
specifies what routes the user is allowed to access.  In our example, we’re
giving them access to all routes, denoted by a <code class="docutils literal notranslate"><span class="pre">*</span></code>.</p>
<p>Now that we have our authorizer, we can associate with a route by providing
the function as the value of the <code class="docutils literal notranslate"><span class="pre">authorizer=</span></code> parameter.  We saw this in the
<a class="reference internal" href="#todo-app-rest-api"><span class="std std-ref">Rest API</span></a> section above.  For example, note that the
<code class="docutils literal notranslate"><span class="pre">&#64;app.route()</span></code> decorator is being provided an <code class="docutils literal notranslate"><span class="pre">authorizer</span></code> function:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">app.py</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">67</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/todos&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">],</span> <span class="n">authorizer</span><span class="o">=</span><span class="n">jwt_auth</span><span class="p">)</span>
<span class="linenos">68</span><span class="k">def</span> <span class="nf">list_todos</span><span class="p">():</span>
<span class="linenos">69</span>    <span class="n">username</span> <span class="o">=</span> <span class="n">get_authorized_username</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="p">)</span>
<span class="linenos">70</span>    <span class="k">return</span> <span class="n">get_app_db</span><span class="p">()</span><span class="o">.</span><span class="n">list_items</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="cleaning-up">
<h2>Cleaning Up<a class="headerlink" href="#cleaning-up" title="Permalink to this headline">¶</a></h2>
<p>Once you’re finished experimenting with this sample app, you can cleanup your
resources by deleting the Chalice app and deleting any additional resources
associated with this app.  To do this, first delete your Chalice app:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice delete
Deleting Rest API: q7dc49grhk
Deleting function: arn:aws:lambda:us-west-w:12345:function:mytodo-dev-jwt_auth
Deleting IAM role: mytodo-dev-jwt_auth
Deleting function: arn:aws:lambda:us-west-w:12345:function:mytodo-dev
Deleting IAM role: mytodo-dev-api_handler
</pre></div>
</div>
<p>Then to cleanup the remaining resources, rerun the
<code class="docutils literal notranslate"><span class="pre">create-resources.py</span></code> script with the <code class="docutils literal notranslate"><span class="pre">--cleanup</span></code> flag.  This will delete
the DynamoDB tables and the SSM parameter, along with any additional resources
created as part of your Chalice app:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python create-resources.py --cleanup
Deleting table: todo-app-632a558c-8355-4c2d-a46e-24350f371389
Deleting table: users-app-05b34fa2-1ae6-4d81-95d1-7ced59878a2b
Deleting SSM param: /todo-sample-app/auth-key
Resources deleted.  If you haven&#39;t already, be sure to run &#39;chalice delete&#39; to delete your Chalice application.
</pre></div>
</div>
</section>
</section>


                    
                    <section class="relations">
                        
                        <a href="../media-query/index.html" title="previous chapter" class="previous-page clearfix hidden-xs">← Media Query Application</a>
                        
                        <a href="../../upgrading.html" title="next chapter" class="next-page clearfix">Upgrade Notes →</a>
                    </section>
                    
                </article><aside id="right-column" class="side-column hidden-sm">
                    <div class="column-body">
                        <section class="sidebar">
                            
                            <section class="next-previous">
                                
                                <a href="../media-query/index.html" title="previous chapter" class="previous-page clearfix hidden-xs">← Prev</a>
                                
                                <a href="../../upgrading.html" title="next chapter" class="next-page clearfix">Next →</a>
                            </section>
                            
                            <ul>
<li><a class="reference internal" href="#">Todo Application</a><ul>
<li><a class="reference internal" href="#architecture">Architecture</a><ul>
<li><a class="reference internal" href="#rest-api">REST API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deployment">Deployment</a></li>
<li><a class="reference internal" href="#using-the-application">Using the Application</a></li>
<li><a class="reference internal" href="#code-walkthrough">Code Walkthrough</a><ul>
<li><a class="reference internal" href="#todo-app-rest-api">Rest API</a></li>
<li><a class="reference internal" href="#data-storage">Data Storage</a></li>
<li><a class="reference internal" href="#jwt-authentication">JWT Authentication</a><ul>
<li><a class="reference internal" href="#users-table">Users Table</a></li>
<li><a class="reference internal" href="#login-flow">Login Flow</a></li>
<li><a class="reference internal" href="#custom-authorizer">Custom Authorizer</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#cleaning-up">Cleaning Up</a></li>
</ul>
</li>
</ul>

                        </section>
                    </div>
                </aside></div>
        </section>
        
    
<footer id="footer">
    <div class="width-wrapper">
        <div class="copyright">
            <p>©2020, Amazon Web Services, Inc or its affiliates. All rights reserved.</p>
        </div>
    </div>
</footer>
  </body>
</html>