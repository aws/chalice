
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Media Query Application &#8212; AWS Chalice</title><link rel="stylesheet" href="../../_static/bootstrap-reboot.css" type="text/css" />
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom-tabs.css" type="text/css" />
    

    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript">
        function _scroll(subjectId) {
            var subjectElement = $(subjectId);
            var actualSubjectHeight = subjectElement.height();
            var startingPosition = subjectElement[0].getBoundingClientRect().top;
            return function() {
                var availableHeight = $(window).height() - startingPosition;
                // Subtract the scroll position to account for sticky movement.
                availableHeight += Math.min($(window).scrollTop(), 40);
                var cappedHeight = Math.min(actualSubjectHeight, availableHeight);
                if (subjectElement.css("height") !== cappedHeight) {
                    subjectElement.css("height", cappedHeight);
                }
            };
        }

        // Scroll and resize the the columns when scrolled.
        $(function() {
            var rightScroll = _scroll("#right-column > .column-body");
            var scrollFn = function() {
                rightScroll.call(this, arguments);
            };
            scrollFn();
            $(window).scroll(scrollFn);
            $(window).resize(scrollFn);
        });

        // Scroll spy to change highlighted navigation element.
        $(function() {
            var section = document.querySelectorAll(".section");
            var sections = {};
            var i = 0;
            Array.prototype.forEach.call(section, function(e) {
                sections[e.id] = e.offsetTop;
            });
            var scrollSpy = function() {
                var scrollPosition = document.documentElement.scrollTop || document.body.scrollTop;
                for (i in sections) {
                    if (sections[i] <= scrollPosition) {
                        $('#right-column .current').removeClass('current');
                        $("#right-column a[href='#" + i + "']").addClass('current');
                    }
                }
            };
            $(window).scroll(scrollSpy);
            scrollSpy();
        });
    </script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-168492171-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-168492171-3');
    </script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Upgrade Notes" href="../../upgrading.html" />
    <link rel="prev" title="Sample Applications" href="../index.html" />
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  </head><body>
    <header>
        <div class="header-flex width-wrapper">
            <div class="site-logo">
                <a href="../../index.html">
		  <span class="logo-icon"><img src="../../_static/img/chalice-logo-icon-small.png" /></span>
                </a>
            </div>

            <ul id="page-navigation">
                <li class="site-page first"><a href="../../quickstart.html">Quick Start</a></li>
                <li class="site-page"><a href="../../tutorials/index.html">Tutorials</a></li>
                <li class="site-page"><a href="../../main.html">Documentation</a></li>
                <li class="site-page"><a href="https://github.com/aws/chalice">Code</a></li>
                <li class="site-search hidden-sm">
                    <form action="../../search.html" method="get">
                        <input type="hidden" name="check_keywords" value="yes" />
                        <input type="hidden" name="area" value="default" />
                        <input class="search-input" autocomplete="off" type="search" name="q" placeholder="Search" />
                    </form>
                </li>
            </ul>
        </div>
    </header>
    
        
        
        <section id="page-container">
            <div class="width-wrapper flex">
                <article id="document-body">
                    
                    <ul class="rel-parents">
                    <li><a href="../index.html" accesskey="U">Sample Applications</a></li>
                    </ul>
                    
                    
  <div class="section" id="media-query-application">
<h1>Media Query Application<a class="headerlink" href="#media-query-application" title="Permalink to this headline">¶</a></h1>
<p>This sample application shows how to combine multiple event handlers in Chalice
to create an image processing pipeline.  It takes as input any image or video
and it will identify objects, people, text, scenes, and activities.  This
results of this analysis can then be queried with a REST API.</p>
<p>There are several components of this application.  The first part is an image
processing pipeline.  The application is registered to automatically process
any media that’s uploaded to an Amazon S3 bucket.  The application will then
use Amazon Rekognition to automatically detect labels in either the image
or the video.  The returned labels are then stored in an Amazon DynamoDB
table.</p>
<p>For videos, an asynchronous job is started.  This is because the analysis
for videos takes longer than analyzing images so we don’t want our Lambda
function to block until the job is complete.  To handle this asynchronous
job, we subscribe to an Amazon SNS topic.  When the asynchronous job
is finished analyzing our uploaded video, an event handler is called that
will retrieve the results and store the labels in Amazon DynamoDB.</p>
<p>The final component is the REST API.  This allows users to query for
labels associated with the media that has been uploaded.</p>
<p>You can find the full source code for this application in our
<a class="reference external" href="https://github.com/aws-samples/chalice-workshop/tree/master/code/media-query/final">samples directory on GitHub</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone git://github.com/aws/chalice
$ cd chalice/docs/source/samples/media-query/code
</pre></div>
</div>
<p>We’ll now walk through the architecture of the application, how to
deploy and use the application, and go over the application code.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This sample application is also available as a <a class="reference external" href="https://chalice-workshop.readthedocs.io/en/latest/media-query/index.html">workshop</a>.
The main difference between the sample apps here and the Chalice workshops
is that the workshop is a detailed step by step process for how to create
this application from scratch.  You build the app by gradually adding each
feature piece by piece.  It takes several hours to work through all the
workshop material.  In this document we review the architecture,
the deployment process, then walk through the main sections of the code.</p>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>Below is the architecture for the application.</p>
<a class="reference internal image-reference" href="../../_images/architecture.jpg"><img alt="Architecture diagram" src="../../_images/architecture.jpg" style="width: 100%;" /></a>
<p>The main components of the application are as follows:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">handle_object_created</span></code>: A Lambda function that is triggered when an
object is uploaded to a S3 bucket. If the object is an image, it will
call Amazon Rekognition’s <code class="docutils literal notranslate"><span class="pre">DetectLabels</span></code> API to detect objects in the
image. With the detected objects, the Lambda function will then add the
object to an Amazon DynamoDB table. If the object is a video, it will call
Rekognition’s <code class="docutils literal notranslate"><span class="pre">StartLabelDetection</span></code> API to initiate an asynchronous
job to detect labels in the video. When the job is completed, a completion
notification is pushed to an SNS topic.</li>
<li><code class="docutils literal notranslate"><span class="pre">handle_object_deleted</span></code>: A Lambda function that removes the object from
the DynamoDB table if the object is deleted from the S3 bucket.</li>
<li><code class="docutils literal notranslate"><span class="pre">add_video_labels</span></code>: A Lambda function that is triggered on video label
detection SNS messages. On invocation, it will call Rekognition’s
<code class="docutils literal notranslate"><span class="pre">GetLabelDetection</span></code> API to retrieve all detected objects from the video.
It then adds the video with its labels to the DynamoDB Table</li>
<li><code class="docutils literal notranslate"><span class="pre">api_handler</span></code>: A Lambda function that is invoked by HTTP requests to
Amazon API Gateway. On invocation, it will query the database based on the
received HTTP request and return the results to the user through API Gateway.</li>
</ul>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>To deploy the application, first install the necessary requirements and
install the AWS CLI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install -r requirements.txt
$ pip install awscli
</pre></div>
</div>
<p>Then use the AWS CLI to deploy a CloudFormation stack containing the S3 bucket,
DynamoDB table, and SNS topic needed to run this application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws cloudformation deploy --template-file resources.json --stack-name media-query --capabilities CAPABILITY_IAM
</pre></div>
</div>
<p>Record the deployed resources as environment variables in the Chalice
application by running the <cite>recordresources.py</cite> script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python recordresources.py --stack-name media-query
</pre></div>
</div>
<p>Once those resources are created and recorded, deploy the Chalice application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice deploy
</pre></div>
</div>
</div>
<div class="section" id="using-the-application">
<h2>Using the Application<a class="headerlink" href="#using-the-application" title="Permalink to this headline">¶</a></h2>
<p>Once the application is deployed, use the AWS CLI to fetch the name of the
bucket that is storing the media files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws cloudformation describe-stacks --stack-name media-query \
    --query &quot;Stacks[0].Outputs[?OutputKey==&#39;MediaBucketName&#39;].OutputValue&quot; \
    --output text
media-query-mediabucket-xtrhd3c4b59
</pre></div>
</div>
<p>Upload some sample media files to your Amazon S3 bucket so the system populates
information about the media files in your DynamoDB table.  If you need sample
media files, you can use the included samples from the corresponding
<a class="reference external" href="https://chalice-workshop.readthedocs.io/en/latest/media-query/index.html">Chalice workshop</a> assets
<a class="reference external" href="https://github.com/aws-samples/chalice-workshop/tree/master/code/media-query/final/assets">here</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws s3 cp assets/sample.jpg s3://media-query-mediabucket-xtrhd3c4b59/sample.jpg
$ aws s3 cp assets/sample.mp4 s3://media-query-mediabucket-xtrhd3c4b59/sample.mp4
</pre></div>
</div>
<p>Wait about a minute for the media files to be populated in the database and
then install HTTPie:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install httpie
</pre></div>
</div>
<p>Then, list out all if the media files using the application’s API with HTTPie:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice url
https://qi5hf4djdg.execute-api.us-west-2.amazonaws.com/api/

$ http https://qi5hf4djdg.execute-api.us-west-2.amazonaws.com/api/
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 279
Content-Type: application/json
Date: Tue, 10 Jul 2018 17:58:40 GMT
Via: 1.1 fa751ee53e2bf18781ae98b293ff9375.cloudfront.net (CloudFront)
X-Amz-Cf-Id: sNnrzvbdvgj1ZraySJvfSUbHthC_fok8l5GJ7glV4QcED_M1c8tlvg==
X-Amzn-Trace-Id: Root=1-5b44f3d0-4546157e8f5e35a008d06d88;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: J0sIlHs3vHcFj9g=
x-amzn-RequestId: e0aaf4e1-846a-11e8-b756-99d52d342d60

[
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    },
    {
        &quot;labels&quot;: [
            &quot;Human&quot;,
            &quot;Clothing&quot;,
            &quot;Dog&quot;,
            &quot;Nest&quot;,
            &quot;Person&quot;,
            &quot;Footwear&quot;,
            &quot;Bird Nest&quot;,
            &quot;People&quot;,
            &quot;Animal&quot;,
            &quot;Husky&quot;
        ],
        &quot;name&quot;: &quot;sample.mp4&quot;,
        &quot;type&quot;: &quot;video&quot;
    }
]
</pre></div>
</div>
<p>You can include query string parameters as well to query all objects based
on what the file name starts with, the type of the media file, and the detected
objects in the media file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http https://qi5hf4djdg.execute-api.us-west-2.amazonaws.com/api/ startswith==sample.m
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 153
Content-Type: application/json
Date: Tue, 10 Jul 2018 19:20:02 GMT
Via: 1.1 aa42484f82c16d99015c599631def20c.cloudfront.net (CloudFront)
X-Amz-Cf-Id: euqlOlWN5k5V_zKCJy4SL988Vcje6W5jDR88GrWr5uYGH-_ZvN4arg==
X-Amzn-Trace-Id: Root=1-5b4506e0-db041a3492ee56e8f3d9457c;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: J04DHE92PHcF--Q=
x-amzn-RequestId: 3d82319d-8476-11e8-86d9-a1e4585e5c26

[
    {
        &quot;labels&quot;: [
            &quot;Human&quot;,
            &quot;Clothing&quot;,
            &quot;Dog&quot;,
            &quot;Nest&quot;,
            &quot;Person&quot;,
            &quot;Footwear&quot;,
            &quot;Bird Nest&quot;,
            &quot;People&quot;,
            &quot;Animal&quot;,
            &quot;Husky&quot;
        ],
        &quot;name&quot;: &quot;sample.mp4&quot;,
        &quot;type&quot;: &quot;video&quot;
    }
]

$ http https://qi5hf4djdg.execute-api.us-west-2.amazonaws.com/api/ media-type==image
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 126
Content-Type: application/json
Date: Tue, 10 Jul 2018 19:20:53 GMT
Via: 1.1 88eb066576c1b47cd896ab0019b9f25f.cloudfront.net (CloudFront)
X-Amz-Cf-Id: rwuOwzLKDM4KgcSBXFihWeNNsYSpZDYVpc8IXdT0xOu8qz8aA2Pj3w==
X-Amzn-Trace-Id: Root=1-5b450715-de71cf04ca2900b839ff1194;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: J04LaE6YPHcF3VA=
x-amzn-RequestId: 5d29d59a-8476-11e8-a347-ebb5d5f47789

[
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]

$ http https://qi5hf4djdg.execute-api.us-west-2.amazonaws.com/api/ label==Person
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 153
Content-Type: application/json
Date: Tue, 10 Jul 2018 19:20:02 GMT
Via: 1.1 aa42484f82c16d99015c599631def20c.cloudfront.net (CloudFront)
X-Amz-Cf-Id: euqlOlWN5k5V_zKCJy4SL988Vcje6W5jDR88GrWr5uYGH-_ZvN4arg==
X-Amzn-Trace-Id: Root=1-5b4506e0-db041a3492ee56e8f3d9457c;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: J04DHE92PHcF--Q=
x-amzn-RequestId: 3d82319d-8476-11e8-86d9-a1e4585e5c26

[
    {
        &quot;labels&quot;: [
            &quot;Human&quot;,
            &quot;Clothing&quot;,
            &quot;Dog&quot;,
            &quot;Nest&quot;,
            &quot;Person&quot;,
            &quot;Footwear&quot;,
            &quot;Bird Nest&quot;,
            &quot;People&quot;,
            &quot;Animal&quot;,
            &quot;Husky&quot;
        ],
        &quot;name&quot;: &quot;sample.mp4&quot;,
        &quot;type&quot;: &quot;video&quot;
    }
]
</pre></div>
</div>
<p>You can also query for a specific object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http https://qi5hf4djdg.execute-api.us-west-2.amazonaws.com/api/sample.jpg
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 126
Content-Type: application/json
Date: Tue, 10 Jul 2018 19:20:53 GMT
Via: 1.1 88eb066576c1b47cd896ab0019b9f25f.cloudfront.net (CloudFront)
X-Amz-Cf-Id: rwuOwzLKDM4KgcSBXFihWeNNsYSpZDYVpc8IXdT0xOu8qz8aA2Pj3w==
X-Amzn-Trace-Id: Root=1-5b450715-de71cf04ca2900b839ff1194;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: J04LaE6YPHcF3VA=
x-amzn-RequestId: 5d29d59a-8476-11e8-a347-ebb5d5f47789

[
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]
</pre></div>
</div>
</div>
<div class="section" id="code-walkthrough">
<h2>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Permalink to this headline">¶</a></h2>
<p>We’ll take a top-down approach with this application and start with the main
entry point, the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file.  The source code for this application is
split between the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> as well as supporting code in <code class="docutils literal notranslate"><span class="pre">chalicelib/</span></code>.</p>
<div class="section" id="event-handlers">
<h3>Event Handlers<a class="headerlink" href="#event-handlers" title="Permalink to this headline">¶</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> we see four different decorator types, each corresponding
to Lambda functions that are triggered by different events.  Note that
the line numbers correspond to the line numbers in the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectCreated:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_created</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_is_video</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">_handle_created_video</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectRemoved:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_removed</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_is_video</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">delete_media_file</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_sns_message</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VIDEO_TOPIC_NAME&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_video_file</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">get_rekognition_client</span><span class="p">()</span><span class="o">.</span><span class="n">get_video_job_labels</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;JobId&#39;</span><span class="p">])</span>
    <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">add_media_file</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;Video&#39;</span><span class="p">][</span><span class="s1">&#39;S3ObjectName&#39;</span><span class="p">],</span>
        <span class="n">media_type</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">VIDEO_TYPE</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_media_files</span><span class="p">():</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">_extract_db_list_params</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">list_media_files</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span><span class="s1">&#39;Media file (</span><span class="si">%s</span><span class="s1">) not found&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">item</span>
</pre></div>
</td></tr></table></div>
<p>The first two decorators use <code class="docutils literal notranslate"><span class="pre">&#64;app.on_s3_event</span></code> and are specifying
that these two Lambda functions should be invoked when an object is
created or deleted from S3, respectively.  The name of the S3 bucket
is not hardcoded in the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file but instead pulled from the
environment variable <code class="docutils literal notranslate"><span class="pre">MEDIA_BUCKET_NAME</span></code>.  The <code class="docutils literal notranslate"><span class="pre">recordresources.py</span></code>
script that was run as part of the deployment process described above
automatically created these resources and updated the Chalice config file
(<code class="docutils literal notranslate"><span class="pre">.chalice/config.json</span></code>) with these values.  If you look at the
contents of your <code class="docutils literal notranslate"><span class="pre">.chalice/config.json</span></code> file, it should look something
like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;app_name&quot;</span><span class="p">:</span> <span class="s2">&quot;media-query&quot;</span><span class="p">,</span>
  <span class="nt">&quot;stages&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;dev&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;api_gateway_stage&quot;</span><span class="p">:</span> <span class="s2">&quot;api&quot;</span><span class="p">,</span>
      <span class="nt">&quot;autogen_policy&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;environment_variables&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;MEDIA_TABLE_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;media-query-MediaTable-10QEPR0O8DOT4&quot;</span><span class="p">,</span>
        <span class="nt">&quot;MEDIA_BUCKET_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;media-query-mediabucket-fb8oddjbslv1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;VIDEO_TOPIC_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;media-query-VideoTopic-KU38EEHIIUV1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;VIDEO_ROLE_ARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::123456789123:role/media-query-VideoRole-1GKK0CA30VCAD&quot;</span><span class="p">,</span>
        <span class="nt">&quot;VIDEO_TOPIC_ARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sns:us-west-2:123456789123:media-query-VideoTopic-KU38EEHIIUV1&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, the <code class="docutils literal notranslate"><span class="pre">&#64;app.on_sns_message</span></code> is used to connect an SNS topic to our
Lambda function.  This is only used for video processing with Rekognition.
Because of the longer processing times of video compared to images,
video analysis is performed by first starting a “video label job”.  When
you start this asynchronous job, we can specify an SNS topic that
Rekognition will publish to when the job is complete, as shown in the
<code class="docutils literal notranslate"><span class="pre">_handle_created_video</span></code> function below.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>111
112
113
114
115</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_handle_created_video</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">get_rekognition_client</span><span class="p">()</span><span class="o">.</span><span class="n">start_video_label_job</span><span class="p">(</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">topic_arn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VIDEO_TOPIC_ARN&#39;</span><span class="p">],</span>
        <span class="n">role_arn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;VIDEO_ROLE_ARN&#39;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">add_video_file()</span></code> function will then query for the results
of the job (the <code class="docutils literal notranslate"><span class="pre">JobId</span></code> is provided as part of the SNS message
that’s published) and store the results in the DynamoDB table.</p>
<p>The final two decorators of this app creates a REST API with
Amazon API Gateway and defines two routes: <code class="docutils literal notranslate"><span class="pre">/</span></code> and <code class="docutils literal notranslate"><span class="pre">/{name}</span></code>.</p>
<p>Requesting the root URL of <code class="docutils literal notranslate"><span class="pre">/</span></code> is equivalent to a “List” API call that will
return all the media files that have been analyzed so far.  Request
<code class="docutils literal notranslate"><span class="pre">/{name}</span></code>, where <code class="docutils literal notranslate"><span class="pre">{name}</span></code> is the name of the media file that was uploaded
to S3 will return the detected labels for that single resource.  This is
equivalend to a “Get” API call.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This sample application returns all analyzed media files in its
List API call.  In practice, you should paginate your List API calls
to ensure you don’t return unbounded results.</p>
</div>
</div>
<div class="section" id="supporting-files">
<h3>Supporting Files<a class="headerlink" href="#supporting-files" title="Permalink to this headline">¶</a></h3>
<p>The event handlers described in the previous section interact with
Rekognition and DynamoDB through clients that are accessed through
<code class="docutils literal notranslate"><span class="pre">get_rekognition_client()</span></code> and <code class="docutils literal notranslate"><span class="pre">get_rekognition_client()</span></code>
respectively.  These clients are high level wrappers to the corresponding
boto3 clients/resources for these services.  The code for these
high level clients are in <code class="docutils literal notranslate"><span class="pre">chalicelib/rekognition.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">chalicelib/db.py</span></code>.  If we look at the <code class="docutils literal notranslate"><span class="pre">DynamoMediaDB.add_media_file()</span></code>
method in the <code class="docutils literal notranslate"><span class="pre">chalicelib/db.py</span></code> file, we see that it’s a small wrapper
around the <code class="docutils literal notranslate"><span class="pre">put_item()</span></code> operation of the underlying DynamoDB API:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">add_media_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">media_type</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">media_type</span><span class="p">,</span>
                <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>We see a similar pattern in <code class="docutils literal notranslate"><span class="pre">chalicelib/rekognition.py</span></code>.  Here’s the
<code class="docutils literal notranslate"><span class="pre">start_video_label_job</span></code> job that starts the asynchronous processing
discussed in the previous section.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">start_video_label_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">topic_arn</span><span class="p">,</span> <span class="n">role_arn</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boto3_client</span><span class="o">.</span><span class="n">start_label_detection</span><span class="p">(</span>
            <span class="n">Video</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;S3Object&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;Bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span>
                    <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">key</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="n">ClientRequestToken</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="n">NotificationChannel</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;SNSTopicArn&#39;</span><span class="p">:</span> <span class="n">topic_arn</span><span class="p">,</span>
                <span class="s1">&#39;RoleArn&#39;</span><span class="p">:</span> <span class="n">role_arn</span>
            <span class="p">},</span>
            <span class="n">MinConfidence</span><span class="o">=</span><span class="mf">50.0</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;JobId&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>As you can see, it’s a small wrapper around the <code class="docutils literal notranslate"><span class="pre">start_label_detection</span></code>
operation of the underlying Rekognition API.</p>
<p>We encourage you to look through the rest of the <code class="docutils literal notranslate"><span class="pre">chalicelib/</span></code> directory
to see how these high level clients are implemented.</p>
</div>
</div>
<div class="section" id="cleaning-up">
<h2>Cleaning Up<a class="headerlink" href="#cleaning-up" title="Permalink to this headline">¶</a></h2>
<p>If you’re done experimenting with this sample app, you can run these commands
to delete this app.</p>
<ol class="arabic">
<li><p class="first">Delete the chalice application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice delete
Deleting Rest API: kyfn3gqcf0
Deleting function: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev
Deleting IAM role: media-query-dev-api_handler
Deleting function: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-add_video_file
Deleting IAM role: media-query-dev-add_video_file
Deleting function: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-handle_object_removed
Deleting IAM role: media-query-dev-handle_object_removed
Deleting function: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-handle_object_created
Deleting IAM role: media-query-dev-handle_object_created
</pre></div>
</div>
</li>
<li><p class="first">Delete all objects in your S3 bucket:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws s3 rm s3://$MEDIA_BUCKET_NAME --recursive
delete: s3://media-query-mediabucket-4b1h8anboxpa/sample.jpg
delete: s3://media-query-mediabucket-4b1h8anboxpa/sample.mp4
</pre></div>
</div>
</li>
<li><p class="first">Delete the CloudFormation stack containing the additional AWS resources:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws cloudformation delete-stack --stack-name media-query
</pre></div>
</div>
</li>
</ol>
</div>
</div>


                    
                    <section class="relations">
                        
                        <a href="../index.html" title="previous chapter" class="previous-page clearfix hidden-xs">← Sample Applications</a>
                        
                        <a href="../../upgrading.html" title="next chapter" class="next-page clearfix">Upgrade Notes →</a>
                    </section>
                    
                </article><aside id="right-column" class="side-column hidden-sm">
                    <div class="column-body">
                        <section class="sidebar">
                            
                            <section class="next-previous">
                                
                                <a href="../index.html" title="previous chapter" class="previous-page clearfix hidden-xs">← Prev</a>
                                
                                <a href="../../upgrading.html" title="next chapter" class="next-page clearfix">Next →</a>
                            </section>
                            
                            <ul>
<li><a class="reference internal" href="#">Media Query Application</a><ul>
<li><a class="reference internal" href="#architecture">Architecture</a></li>
<li><a class="reference internal" href="#deployment">Deployment</a></li>
<li><a class="reference internal" href="#using-the-application">Using the Application</a></li>
<li><a class="reference internal" href="#code-walkthrough">Code Walkthrough</a><ul>
<li><a class="reference internal" href="#event-handlers">Event Handlers</a></li>
<li><a class="reference internal" href="#supporting-files">Supporting Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cleaning-up">Cleaning Up</a></li>
</ul>
</li>
</ul>

                        </section>
                    </div>
                </aside></div>
        </section>
        
    
<footer id="footer">
    <div class="width-wrapper">
        <div class="copyright">
            <p>©2020, Amazon Web Services, Inc or its affiliates. All rights reserved.</p>
        </div>
    </div>
</footer>
  </body>
</html>